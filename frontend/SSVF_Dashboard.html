<!DOCTYPE html>
<html>
<head>
    <title>Case Manager Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="global-top-bar">
        <a href="index.html" class="top-bar-link">SSVF VetConnect</a>
        <span class="portal-name">Case Manager Portal</span>
    </div>
    <div class="container">
        <h1>Active Veteran Cases</h1>
        <input id="filterInput" type="text" placeholder="Filter by name, care team, or living situation..." onkeyup="applyFilter()">
        <div style="margin-bottom: 12px;">
            <button class="button-green" onclick="expandAllDetails()">Expand All</button>
            <button class="button-green" onclick="collapseAllDetails()">Collapse All</button>
        </div>
        <div style="margin-bottom: 12px;">
            <label for="caseManagerFilter">Filter by Case Manager:</label>
            <select id="caseManagerFilter">
                <option value="">All Case Managers</option>
                <!-- Populate dynamically -->
            </select>
        </div>
        <table id="veteranTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Name</th>
                    <th>SSN (Last 4)</th>
                    <th onclick="sortTable(1)">Age</th>
                    <th onclick="sortTable(2)">Care Team</th>
                    <th onclick="sortTable(3)">Living Situation</th>
                    <th onclick="sortTable(4)">Last Contact</th>
                    <th onclick="sortTable(5)">Case Notes</th>
                    <th onclick="sortTable(6)">Next Appt</th>
                    <th>Save</th>
                    <th>Details</th>
                    <th>Reassign</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div style="display: flex; justify-content: center;">
        <div class="container" style="margin-top:18px; background:#f6f8fa; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,0.08); padding:24px 20px; max-width:800px; text-align:left;">
            <h2 style="color:#205493; margin-top:0; text-align:center;">Provider Awareness One-Pager for SSVF Health Care Navigators</h2>
            <p style="text-align:center;">
                <b>Guidance for SSVF Health Care Navigators:</b><br>
                Use the <b>Provider Awareness One-Pager</b> to introduce your role to VA Medical Center (VAMC) clinic staff. This one-pager clarifies your responsibilities, authority, and how you support care coordination for Veterans.
            </p>
            <ul style="margin-bottom:10px;">
                <li>Clarifies your role and authority as an SSVF Health Care Navigator</li>
                <li>Explains how you coordinate care and work with VA teams</li>
                <li>Helps VAMC staff understand how to collaborate with you</li>
            </ul>
            <b>Action Steps:</b>
            <ul>
                <li>Fill in your contact info on the one-pager</li>
                <li>Meet with clinic points of contact (POCs) and bring printed copies</li>
                <li>Explain your role and leave copies with VAMC staff and Homeless Program</li>
            </ul>
            <div style="text-align:center; margin-top:18px;">
                <a href="provider_onepager.html" target="_blank" style="color:#205493; text-decoration:underline; font-weight:bold; font-size:1.1em;">
                    Open Printable Provider Awareness One-Pager
                </a>
            </div>
        </div>
    </div>
    <!-- Modal for editing case notes -->
    <div id="notesModal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Edit Case Notes</h3>
            <textarea id="modalNotes"></textarea>
            <div class="modal-actions">
                <button onclick="closeNotesModal()" class="button-red">Cancel</button>
                <button id="saveNotesBtn" class="button-green">Save</button>
            </div>
        </div>
    </div>

    <!-- Modal for reassigning case manager -->
    <div id="reassignModal" class="modal-backdrop" style="display:none;">
        <div class="modal-content">
            <h3>Reassign Veteran</h3>
            <label for="caseManagerSelect">Select new Case Manager:</label>
            <select id="caseManagerSelect"></select>
            <div class="modal-actions">
                <button onclick="closeReassignModal()" class="button-red">Cancel</button>
                <button id="confirmReassignBtn" class="button-green">Reassign</button>
            </div>
        </div>
    </div>

    <script>
        const livingOptions = [
            "Unsheltered", "Shelter", "GPD/CRS", "Housed", "Institution", "Other"
        ];
        let cachedVeterans = [];
        let currentNotesVetId = null;
        let currentNotesLiving = null;
        let currentNotesContact = null;
        let reassignVetId = null;
        let agencyCaseManagers = [];

        // Fetch assigned veterans, then fetch details for each
        async function fetchVeterans(fetchAll = false) {
            const url = fetchAll ? '/api/veterans?all=true' : '/api/veterans';
            const resp = await fetch(url);
            const data = await resp.json();
            if (data.error) {
                alert(data.error);
                return;
            }
            // Fetch details for each veteran using their ICN
            const detailedVeterans = await Promise.all(
                data.map(async vet => {
                    try {
                        const detailResp = await fetch(`/api/patient?id=${vet.id}`);
                        const detail = await detailResp.json();
                        return { ...vet, ...detail };
                    } catch {
                        return vet; // fallback to minimal info
                    }
                })
            );
            cachedVeterans = detailedVeterans;
            renderTable(cachedVeterans);
        }

        // Render table and fetch case notes for each veteran
        function renderTable(veterans) {
            const tbody = document.getElementById('veteranTable').querySelector('tbody');
            tbody.innerHTML = '';
            veterans.forEach((vet, idx) => {
                fetch(`/api/case_notes/${vet.id}`)
                    .then(r => r.json())
                    .then(notes => {
                        const tr = document.createElement('tr');
                        let ssnLast4 = '';
                        if (vet.ssn && vet.ssn.length >= 4) {
                            ssnLast4 = vet.ssn.slice(-4);
                        }
                        tr.innerHTML = `
                            <td>${vet.name || ''}</td>
                            <td>${ssnLast4}</td>
                            <td>${vet.age || ''}</td>
                            <td>
                                ${
                                    (vet.care_teams && vet.care_teams.length > 0)
                                    ? "Yes"
                                    : `None found. <a href="https://eauth.va.gov/accessva/?cspSelectFor=https%3A%2F%2Fwww.my.vaemcc.va.gov%2FSQUARES&ForceAuthn=false" target="_blank">Check Eligibility</a>`
                                }
                            </td>
                            <td>
                                <select>
                                    ${livingOptions.map(opt => `<option value="${opt}"${notes.living_situation === opt ? ' selected' : ''}>${opt}</option>`).join('')}
                                </select>
                            </td>
                            <td>
                                <input type="date" value="${notes.last_contact || ''}">
                            </td>
                            <td>
                                <span class="notes-preview clickable" title="${notes.case_notes || ''}" onclick="openNotesModal('${vet.id}', '${notes.case_notes || ''}', this.parentElement.parentElement.querySelector('select').value, this.parentElement.parentElement.querySelector('input').value)">
                                    ${notes.case_notes && notes.case_notes.length > 0 ? (notes.case_notes.length > 60 ? notes.case_notes.slice(0, 60) + '…' : notes.case_notes) : '—'}
                                </span>
                            </td>
                            <td>${(vet.upcoming_appointments && vet.upcoming_appointments.length > 0) ? new Date(vet.upcoming_appointments[0].date).toLocaleString() : ''}</td>
                            <td>
                                <button class="save-btn button-green" onclick="saveNotes('${vet.id}', this)">Save</button>
                                <span class="save-success" style="display:none;"></span>
                            </td>
                            <td><button class="button-green" onclick="toggleDetails(${idx}, cachedVeterans[${idx}])">Details</button></td>
                            <td><button class="button-green" onclick="reassignVeteran('${vet.id}')">Reassign</button></td>
                        `;
                        tbody.appendChild(tr);

                        // Details row (initially hidden)
                        const detailsTr = document.createElement('tr');
                        detailsTr.className = 'expand-row';
                        detailsTr.id = `details-row-${idx}`;
                        detailsTr.style.display = 'none';
                        const detailsTd = document.createElement('td');
                        detailsTd.colSpan = 10;
                        detailsTd.innerHTML = renderDetails(vet);
                        detailsTr.appendChild(detailsTd);
                        tbody.appendChild(detailsTr);
                    });
            });
        }

        function saveNotes(vetId, btn) {
            const tr = btn.closest('tr');
            const livingSel = tr.querySelector('select');
            const contactInput = tr.querySelector('input[type="date"]');
            const notesPreview = tr.querySelector('.notes-preview');
            fetch('/api/case_notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    icn: vetId,
                    living_situation: livingSel.value,
                    last_contact: contactInput.value,
                    case_notes: notesPreview.title || ''
                })
            }).then(r => r.json()).then(resp => {
                const saveMsg = tr.querySelector('.save-success');
                if (resp.success) {
                    saveMsg.textContent = "Saved!";
                    saveMsg.style.display = "";
                    setTimeout(() => saveMsg.style.display = "none", 1500);
                }
            });
        }

        function renderDetails(vet) {
            let html = '<div style="padding:10px;">';
            if (vet.name) html += `<strong>Name:</strong> ${vet.name}<br>`;
            if (vet.ssn) html += `<strong>SSN:</strong> ${vet.ssn}<br>`; // Show full SSN in details
            if (vet.dob) {
                // Format DOB as "Month Day, Year"
                const dobDate = new Date(vet.dob);
                const dobFormatted = dobDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                html += `<strong>Date of Birth:</strong> ${dobFormatted}<br>`;
            }
            if (vet.age) html += `<strong>Age:</strong> ${vet.age}<br>`;
            if (vet.address) html += `<strong>Address:</strong> ${vet.address}<br>`;
            if (vet.phones && vet.phones.length)
                html += `<strong>Phone(s):</strong> ${vet.phones.join(', ')}<br>`;
            if (vet.emails && vet.emails.length) {
                html += `<strong>Email(s):</strong> ${vet.emails.join(', ')}<br>`;
            }
            if (vet.eligibility) html += `<strong>Eligibility:</strong> ${vet.eligibility}<br>`;
            if (vet.care_teams && vet.care_teams.length > 0) {
                html += `<strong>Care Team:</strong><br>`;
                const groupedByLocation = {};
                vet.care_teams.forEach(team => {
                    const location = team.locations && team.locations.length > 0 ? team.locations[0] : "Unknown Location";
                    if (!groupedByLocation[location]) {
                        groupedByLocation[location] = [];
                    }
                    groupedByLocation[location].push({
                        practitioner: team.practitioner,
                        role: team.role && team.role.length > 0 ? team.role.join(", ") : "Unknown Role",
                    });
                });
                Object.keys(groupedByLocation).forEach(location => {
                    html += `<div style="margin-left: 20px;">
                                <strong>Location:</strong> ${location}
                                <button onclick="toggleCareTeam('${location}')">Expand</button>
                                <div id="careTeam-${location}" style="display: none; margin-left: 20px;">
                                    ${groupedByLocation[location].map(practitioner => `
                                        <div>
                                            <strong>Practitioner:</strong> ${practitioner.practitioner}<br>
                                            <strong>Role:</strong> ${practitioner.role}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>`;
                });
            }
            if (vet.past_appointments && vet.past_appointments.length) {
                html += `<strong>Past Appointments (6mo):</strong><ul>`;
                vet.past_appointments.forEach(appt => {
                    html += `<li>${appt.date ? new Date(appt.date).toLocaleString() : ''} - ${appt.description || appt.service_type || appt.reason || ''} (${appt.status || ''})</li>`;
                });
                html += `</ul>`;
            }
            if (vet.upcoming_appointments && vet.upcoming_appointments.length) {
                html += `<strong>Upcoming Appointments:</strong><ul>`;
                vet.upcoming_appointments.forEach(appt => {
                    html += `<li>${appt.date ? new Date(appt.date).toLocaleString() : ''} - ${appt.description || appt.service_type || appt.reason || ''} (${appt.status || ''})</li>`;
                });
                html += `</ul>`;
            }
            if (vet.consults && vet.consults.length) {
                html += `<strong>Active Consults/Referrals:</strong><ul>`;
                vet.consults.forEach(c => {
                    html += `<li>${c.description || ''} (${c.status || ''})</li>`;
                });
                html += `</ul>`;
            }
            if (vet.radiology_orders && vet.radiology_orders.length) {
                html += `<strong>Pending Radiology Orders:</strong><ul>`;
                vet.radiology_orders.forEach(r => {
                    html += `<li>${r.description || ''} (${r.status || ''})</li>`;
                });
                html += `</ul>`;
            }
            html += '</div>';
            return html;
        }

        function toggleDetails(idx, vet) {
            const row = document.getElementById(`details-row-${idx}`);
            if (row.style.display === 'none') {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }

        // Modal logic for editing case notes
        function openNotesModal(vetId, notes, living, contact) {
            currentNotesVetId = vetId;
            currentNotesLiving = living;
            currentNotesContact = contact;
            document.getElementById('modalNotes').value = notes;
            document.getElementById('notesModal').classList.add('active');
        }
        function closeNotesModal() {
            document.getElementById('notesModal').classList.remove('active');
            currentNotesVetId = null;
        }
        document.getElementById('saveNotesBtn').onclick = function() {
            const newNotes = document.getElementById('modalNotes').value;
            fetch('/api/case_notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    icn: currentNotesVetId,
                    living_situation: currentNotesLiving,
                    last_contact: currentNotesContact,
                    case_notes: newNotes
                })
            }).then(r => r.json()).then(resp => {
                closeNotesModal();
                fetchVeterans();
            });
        };

        // Fetch case managers for the agency (if not already loaded)
        async function loadCaseManagersForReassign() {
            if (agencyCaseManagers.length === 0) {
                const sessionResp = await fetch('/api/case_manager_session');
                const sessionData = await sessionResp.json();
                const agencyId = sessionData.agency_id;
                const resp = await fetch(`/api/case_managers?agency_id=${agencyId}`);
                agencyCaseManagers = await resp.json();
            }
            return agencyCaseManagers;
        }

        function reassignVeteran(vetId) {
            reassignVetId = vetId;
            loadCaseManagersForReassign().then(caseManagers => {
                const select = document.getElementById('caseManagerSelect');
                select.innerHTML = '';
                caseManagers.forEach(cm => {
                    const option = document.createElement('option');
                    option.value = cm.id;
                    option.textContent = cm.username;
                    select.appendChild(option);
                });
                document.getElementById('reassignModal').style.display = 'block';
            });
        }

        function closeReassignModal() {
            document.getElementById('reassignModal').style.display = 'none';
            reassignVetId = null;
        }

        document.getElementById('confirmReassignBtn').onclick = function() {
            const newCaseManagerId = document.getElementById('caseManagerSelect').value;
            if (!newCaseManagerId) return;
            fetch('/api/reassign_veteran', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    veteran_id: reassignVetId,
                    new_case_manager_id: parseInt(newCaseManagerId)
                })
            })
            .then(r => r.json())
            .then(resp => {
                if (resp.success) {
                    alert("Veteran reassigned successfully!");
                    closeReassignModal();
                    fetchVeterans();
                } else {
                    alert(resp.error || "Failed to reassign veteran.");
                }
            });
        };

        // Populate case manager filter and fetch veterans on load
        document.addEventListener('DOMContentLoaded', async () => {
            const caseManagerFilter = document.getElementById('caseManagerFilter');
            const sessionResp = await fetch('/api/case_manager_session');
            const sessionData = await sessionResp.json();
            const agencyId = sessionData.agency_id;

            if (!agencyId) return;

            const response = await fetch(`/api/case_managers?agency_id=${agencyId}`);
            const caseManagers = await response.json();

            caseManagers.forEach(cm => {
                const option = document.createElement('option');
                option.value = cm.id;
                option.textContent = cm.username;
                caseManagerFilter.appendChild(option);
            });

            // Fetch and display veterans
            await fetchVeterans();

            // Filter logic
            caseManagerFilter.addEventListener('change', async () => {
                const selectedCaseManagerId = caseManagerFilter.value;
                if (selectedCaseManagerId) {
                    await fetchVeteransByCaseManager(selectedCaseManagerId);
                } else {
                    // Fetch all agency veterans when "All Case Managers" is selected
                    await fetchVeterans(true);
                }
            });
        });

        async function fetchVeteransByCaseManager(caseManagerId) {
            let url = '/api/veterans';
            if (caseManagerId) {
                url += `?case_manager_id=${caseManagerId}`;
            }
            const resp = await fetch(url);
            const data = await resp.json();
            if (data.error) {
                alert(data.error);
                return;
            }
            // Fetch details as before
            cachedVeterans = await Promise.all(
                data.map(async vet => {
                    try {
                        const detailResp = await fetch(`/api/patient?id=${vet.id}`);
                        const detail = await detailResp.json();
                        return { ...vet, ...detail };
                    } catch {
                        return vet;
                    }
                })
            );
            renderTable(cachedVeterans);
        }

        function expandAllDetails() {
            const tbody = document.getElementById('veteranTable').querySelector('tbody');
            Array.from(tbody.querySelectorAll('tr.expand-row')).forEach(row => {
                row.style.display = '';
            });
        }
        function collapseAllDetails() {
            const tbody = document.getElementById('veteranTable').querySelector('tbody');
            Array.from(tbody.querySelectorAll('tr.expand-row')).forEach(row => {
                row.style.display = 'none';
            });
        }

        function toggleCareTeam(location) {
            const careTeamDiv = document.getElementById(`careTeam-${location}`);
            if (careTeamDiv.style.display === "none") {
                careTeamDiv.style.display = "block";
            } else {
                careTeamDiv.style.display = "none";
            }
        }

        // Filter table by name, care team, or living situation
        function applyFilter() {
            const filter = document.getElementById('filterInput').value.toLowerCase();
            const tbody = document.getElementById('veteranTable').querySelector('tbody');
            Array.from(tbody.querySelectorAll('tr')).forEach((tr, idx) => {
                if (tr.className === 'expand-row') return;
                const name = tr.children[0].textContent.toLowerCase();
                const care = tr.children[2].textContent.toLowerCase();
                const living = tr.children[3].querySelector('select').value.toLowerCase();
                if (name.includes(filter) || care.includes(filter) || living.includes(filter)) {
                    tr.style.display = '';
                    const detailsRow = tbody.querySelector(`#details-row-${idx}`);
                    if (detailsRow) detailsRow.style.display = 'none';
                } else {
                    tr.style.display = 'none';
                    const detailsRow = tbody.querySelector(`#details-row-${idx}`);
                    if (detailsRow) detailsRow.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>